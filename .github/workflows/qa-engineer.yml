name: AI QA Engineer

# This workflow is designed to be copied to your repository.
# By default, it only runs on manual trigger.
# Uncomment the pull_request trigger below once you have a preview deployment URL configured.

on:
  # Uncomment below to run on PRs (requires preview deployment URL configuration)
  # pull_request:
  #   types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to test (required)'
        required: true
        type: string
      focus:
        description: 'Focus area: accessibility, performance, forms, mobile, all'
        required: false
        type: string
        default: 'all'
      fail_on_bugs:
        description: 'Fail workflow if critical/high bugs found'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  NODE_VERSION: '20'
  PLAYWRIGHT_VERSION: '1.48.0'

jobs:
  qa-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Validate inputs
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -z "${{ inputs.url }}" ]; then
            echo "❌ Error: URL is required"
            echo "Please provide a URL to test when triggering this workflow."
            exit 1
          fi

          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "❌ Error: ANTHROPIC_API_KEY secret is not configured"
            echo "Please add your Anthropic API key to repository secrets."
            exit 1
          fi

          echo "✓ All validations passed"
          echo "✓ Testing URL: ${{ inputs.url }}"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache Playwright Browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ env.PLAYWRIGHT_VERSION }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Dependencies
        run: npm ci
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 'true'

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install chromium --with-deps

      - name: Install Playwright Deps (cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Check URL is reachable
        id: url-check
        run: |
          echo "Checking if URL is reachable..."
          TEST_URL="${{ inputs.url }}"

          # Try to reach the URL
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$TEST_URL" || echo "000")

          if [ "$HTTP_CODE" = "000" ]; then
            echo "⚠️ Warning: Could not reach $TEST_URL (connection failed)"
            echo "reachable=false" >> $GITHUB_OUTPUT
          elif [ "$HTTP_CODE" -ge 400 ]; then
            echo "⚠️ Warning: $TEST_URL returned HTTP $HTTP_CODE"
            echo "reachable=false" >> $GITHUB_OUTPUT
          else
            echo "✓ URL is reachable (HTTP $HTTP_CODE)"
            echo "reachable=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Screenshots Directory
        run: mkdir -p screenshots

      - name: Run AI QA Engineer
        id: qa-run
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TEST_URL: ${{ inputs.url }}
          TEST_FOCUS: ${{ inputs.focus || 'all' }}
        run: |
          echo "::group::QA Testing Configuration"
          echo "URL: $TEST_URL"
          echo "Focus Area: $TEST_FOCUS"
          echo "::endgroup::"

          echo "::group::Starting AI QA Engineer"
          START_TIME=$(date +%s)

          npx @anthropic-ai/claude-code --print \
            --mcp-config .claude/mcp-config.json \
            --system-prompt "$(cat .claude/qa-engineer-prompt.md)" \
            "Test the website at $TEST_URL

             ## Test Configuration
             - Focus area: $TEST_FOCUS

             ## Required Testing

             ### 1. Network & Console Health (First!)
             Before any visual testing:
             - Monitor for failed network requests (4xx, 5xx errors)
             - Monitor for console errors and warnings
             - Note any slow API calls (>3 seconds)
             - Check for missing resources (404s)

             ### 2. Viewport Testing
             Test on these viewports:
             - Mobile: 375x667 (iPhone SE)
             - Tablet: 768x1024 (iPad)
             - Desktop: 1920x1080 (Full HD)

             ### 3. Functional Testing
             - Test all interactive elements (buttons, links, forms)
             - Test navigation flows
             - Test any dynamic content loading
             - Try to break things - rapid clicks, edge cases

             ### 4. Visual Testing
             - Check for layout issues, overflow, cut-off text
             - Verify responsive design works across viewports
             - Check alignment and spacing

             ### 5. Accessibility
             - Tab navigation works
             - Focus states visible
             - Images have alt text

             ## Output Requirements

             1. Save screenshots to ./screenshots/ directory
             2. Create qa-report.md with:
                - Summary (bugs found, severity breakdown)
                - Network health section
                - Console output section
                - Detailed bug reports with steps to reproduce
                - Screenshots referenced by filename
                - Recommendations prioritized by impact

             Be thorough. Think like a user who wants to break things." || {
            echo "⚠️ QA testing encountered an error"
            exit 1
          }

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "✓ QA testing completed in ${DURATION}s"
          echo "::endgroup::"
          echo "qa_duration_seconds=$DURATION" >> $GITHUB_OUTPUT

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: qa-screenshots-${{ github.run_number }}
          path: screenshots/
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload QA Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: qa-report-${{ github.run_number }}
          path: qa-report.md
          retention-days: 14
          if-no-files-found: ignore

      - name: Summary
        if: always()
        run: |
          echo "## AI QA Engineer Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL Tested:** ${{ inputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Focus Area:** ${{ inputs.focus || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "qa-report.md" ]; then
            echo "### Report" >> $GITHUB_STEP_SUMMARY
            cat qa-report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No QA report generated. Check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for critical bugs
        if: ${{ inputs.fail_on_bugs }}
        run: |
          if [ ! -f "qa-report.md" ]; then
            echo "No QA report found - skipping bug check"
            exit 0
          fi

          echo "Checking for critical/high severity bugs..."

          # Case-insensitive search for critical or high severity indicators
          CRITICAL_COUNT=$(grep -i -c -E '(critical|severity:\s*critical)' qa-report.md || echo "0")
          HIGH_COUNT=$(grep -i -c -E '(high|severity:\s*high)' qa-report.md || echo "0")

          echo "Critical bugs: $CRITICAL_COUNT"
          echo "High severity bugs: $HIGH_COUNT"

          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "::error::Found $CRITICAL_COUNT critical bug(s) - failing workflow"
            exit 1
          fi

          if [ "$HIGH_COUNT" -gt 0 ]; then
            echo "::warning::Found $HIGH_COUNT high severity bug(s) - failing workflow"
            exit 1
          fi

          echo "✓ No critical/high severity bugs found"
